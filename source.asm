ORG 0000h

LJMP START


ORG 0003H
   LJMP SHORT_INT_0


ORG 0013H
   LJMP SHORT_INT_1


ORG 001BH
   CLR TF1
   CLR TR1
   CPL P1.0
   ;ACALL ADJUST_HIGH
   CJNE R0,#01H,SKIP_LOW_SEG
   ACALL ADJUST_LOW
   MOV R0,#00H
   SETB TR1
RETI
   SKIP_LOW_SEG:
   ACALL ADJUST_HIGH
   MOV R0,#01H
   SETB TR1
RETI

ORG 0040H
START:
   CLR TR1
   MOV P3,#0FFH
   MOV P2,#0FFH
   MOV P1,#00H
   MOV R0,#01H ;FLAG
   MOV R1,#00 ; SPEED OF MOTOR
   MOV TMOD,#00010000B ; MODE 1
   ACALL ADJUST_HIGH
   SETB TCON.0
   SETB TCON.2
   MOV IE,#8DH  ;int0, int1, tr1
   SETB TR1

LOOP:
   MOV P0,R1
   CJNE R1,#00,CON2
   CLR IE.3
   SETB P1.0
   SJMP LOOP
   CON2:
   CJNE R1,#100,DON
   CLR IE.3
   CLR P1.0
   MOV R3,P2
   CJNE R3,#11111111B,START
   SJMP LOOP
   DON:
   MOV R3,P2
   CJNE R3,#11111111B,START
   MOV IE,#8DH
   SJMP LOOP
   
SHORT_INT_0:
   CJNE R1,#00,DO_2
   RETI
      DO_2:
      JC CLEAR_c
      MOV A,R1
      SUBB A,#10
      MOV R1,A
   RETI
      CLEAR_c:
	 CLR C
	 MOV A,R1
	 SUBB A,#10
	 SETB C
	 MOV R1,A
   RETI   
SHORT_INT_1:
   CJNE R1,#100,DO
   RETI
      DO:
      MOV A,R1
      ADD A,#10
      MOV R1,A
   RETI   
   
 ADJUST_HIGH:
   MOV A,R1
   ACALL ADJUST_CAL
RET

ADJUST_LOW:
   MOV A,#100
   SUBB A,R1
   ACALL ADJUST_CAL
RET

ADJUST_CAL:
   MOV B,#100   ; 100 * 10 = 1000 FC18 ; A=LOW B=HIGH
   MUL AB ; A = R1     INITAIL = (65536 - (1M/1m))   
   MOV R2,A
   MOV A,#0FFH ; FFFF - FC17 
   SUBB A,R2  ; FF - 17
   MOV TL1,A ; = LOW_B
   MOV A,#0FFH
   SUBB A,B ;= FF - FC
   MOV TH1,A ; HIGH_B
RET
   

END